<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador y Simulador GIFT Moodle (Modelo Exacto)</title> <!-- Título Actualizado -->
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <!-- Font Awesome CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* --- Estilos CSS combinados (sin cambios) --- */
        body { background-color: #f8f9fa; padding-top: 20px; padding-bottom: 50px; }
        .main-container { max-width: 950px; margin: auto; }
        #generator-tab .container { max-width: 900px; background-color: #ffffff; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-top: 0; }
        .question-container { border: 1px solid #dee2e6; padding: 15px; margin-bottom: 15px; border-radius: 5px; cursor: pointer; transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out; background-color: #fff; }
        .question-container:hover { background-color: #f1f3f5; border-color: #adb5bd; } .question-container.selected { background-color: #e7f5ff; border-color: #91d5ff; }
        .answer-option { margin-left: 20px; padding: 3px 0; } .answer-option i { font-size: 0.9em; width: 18px; } .question-checkbox { display: none; }
        #model-loading-indicator, #model-error-message { margin-top: 5px; font-size: 0.9em; } #show-api-key { border-left: 0; }
        .download-buttons { margin-top: 15px; margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap; }
        .simulator-buttons { margin-top: 5px; margin-bottom: 25px; display: flex; gap: 10px; flex-wrap: wrap; }
        .feedback-text { color: #6c757d; font-style: italic; font-size: 0.9em; }
        #simulator-tab .container { max-width: 800px; background-color: #ffffff; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-top: 0; }
        #drop-zone { border: 2px dashed #007bff; border-radius: 5px; padding: 40px; text-align: center; color: #007bff; margin-bottom: 20px; transition: background-color 0.3s ease; }
        #drop-zone.dragover { background-color: #e9ecef; }
        .question-card { border: 1px solid #ddd; margin-bottom: 20px; background-color: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .question-header { background-color: #f7f7f7; padding: 10px 15px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; transition: background-color 0.3s ease; }
        .question-number { font-weight: bold; color: #555; } .question-status { font-size: 0.9em; font-weight: bold; } .question-body { padding: 15px; } .question-text { margin-bottom: 15px; font-weight: bold; }
        .answer-options .option-wrapper { display: flex; align-items: center; margin-bottom: 10px; padding: 8px; border-radius: 4px; transition: background-color 0.2s ease; cursor: pointer; border-left: 5px solid transparent; }
        .answer-options input[type="radio"], .answer-options input[type="checkbox"] { margin-right: 10px; flex-shrink: 0; margin-top: 0; cursor: pointer; } .answer-options label { font-weight: normal; margin-bottom: 0; padding: 0; flex-grow: 1; cursor: pointer; display: inline; } .answer-options .option-wrapper:hover { background-color: #f1f3f5; }
        .status-unanswered { color: #6c757d; } .status-answered { color: #0056b3; } .status-correct { color: #155724; } .status-incorrect { color: #721c24; } .status-partially-correct { color: #856404; }
        .header-unanswered { background-color: #f7f7f7; border-left-color: #6c757d; } .header-answered { background-color: #e7f5ff; border-left-color: #007bff; } .header-correct { background-color: #d4edda; border-left-color: #28a745; } .header-incorrect { background-color: #f8d7da; border-left-color: #dc3545; } .header-partially-correct { background-color: #fff3cd; border-left-color: #ffc107; }
        .feedback-icon { margin-left: 10px; font-size: 1.1em; } .correct { color: #28a745; } .incorrect { color: #dc3545; } .option-wrapper.correct-answer-mark { border-left-color: #28a745; } .option-wrapper.user-incorrect-selection { background-color: #f8d7da !important; border-left-color: #dc3545 !important; } .option-wrapper.user-incorrect-selection label { text-decoration: line-through; color: #721c24; }
        .specific-feedback { font-size: 0.9em; color: #6c757d; margin-left: calc(8px + 5px + 10px); margin-top: 2px; margin-bottom: 8px; border-left: 2px solid #eee; padding-left: 8px; }
        .general-feedback { margin-top: 15px; padding: 10px; border-radius: 4px; } .feedback-correct { background-color: #d4edda; border: 1px solid #c3e6cb; } .feedback-incorrect { background-color: #f8d7da; border: 1px solid #f5c6cb; } .feedback-partially-correct { background-color: #fff3cd; border: 1px solid #ffeeba; }
        #quiz-results-area { margin-top: 30px; padding: 20px; border: 1px solid #ddd; background-color: #f9f9f9; }
        #score-summary { line-height: 1.6; } #score-summary strong { color: #0056b3; } .score-out-of-10 { font-size: 1.2em; font-weight: bold; margin-top: -5px; margin-bottom: 15px; }
        .calculation-toggle-button { font-size: 0.9em; padding: 0.1rem 0.4rem; margin-left: 5px; vertical-align: middle; } .score-calc-label { font-weight: bold; margin-bottom: 5px; display: block; } #collapseCalculation { margin-bottom: 15px; } .score-calc-display { font-family: monospace; background-color: #e9ecef; padding: 8px 12px; border-radius: 4px; font-size: 0.95em; display: block; white-space: pre-wrap; overflow-wrap: break-word; }
        .results-details { list-style: none; padding-left: 0; margin-top: 15px; } .results-details li { margin-bottom: 5px; } .results-details .correct-count { color: #28a745; } .results-details .partial-count { color: #ffc107; } .results-details .incorrect-count { color: #dc3545; }
        .results-timestamp { font-size: 0.9em; color: #6c757d; margin-top: 15px; } .results-buttons { display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Pestañas de Navegación (sin cambios) -->
        <ul class="nav nav-tabs" id="myTab" role="tablist"> <li class="nav-item" role="presentation"> <a class="nav-link active" id="generator-nav-tab" data-toggle="tab" href="#generator-tab" role="tab" aria-controls="generator-tab" aria-selected="true"><i class="fas fa-magic mr-1"></i> Generador GIFT</a> </li> <li class="nav-item" role="presentation"> <a class="nav-link" id="simulator-nav-tab" data-toggle="tab" href="#simulator-tab" role="tab" aria-controls="simulator-tab" aria-selected="false"><i class="fas fa-vial mr-1"></i> Simulador</a> </li> </ul>

        <!-- Contenido de las Pestañas -->
        <div class="tab-content pt-3" id="myTabContent">
            <!-- Pestaña 1: Generador GIFT -->
            <div class="tab-pane fade show active" id="generator-tab" role="tabpanel" aria-labelledby="generator-nav-tab">
                <div class="container">
                    <h1 class="mb-4 text-center">Generador Banco Preguntas GIFT Moodle</h1>
                    <!-- Contenido del Generador (sin cambios HTML) -->
                     <div class="form-group"> <label for="gemini-api-key">Clave API de Gemini: <a href="https://makersuite.google.com/app/apikey" target="_blank" rel="noopener noreferrer" title="Obtener Clave API"><i class="fas fa-question-circle text-muted"></i></a> </label> <div class="input-group"> <input type="password" class="form-control" id="gemini-api-key" placeholder="Ingresa tu clave API"> <div class="input-group-append"> <button class="btn btn-outline-secondary" type="button" id="show-api-key" title="Mostrar/Ocultar Clave"><i class="fas fa-eye"></i></button> </div> </div> <div id="model-error-message" class="text-danger" style="display: none;"></div> <div id="model-loading-indicator" class="text-muted" style="display: none;"><i class="fas fa-spinner fa-spin"></i> Cargando modelos...</div> </div>
                     <div class="form-group"> <label for="gemini-model-select">Modelo Gemini:</label> <select class="form-control" id="gemini-model-select" disabled><option value="">Ingresa API Key válida</option></select> </div>
                     <div class="form-group"> <label for="quiz-topic">Descripción del Tema:</label> <textarea class="form-control" id="quiz-topic" rows="4" placeholder="Ej: Conceptos básicos de redes..."></textarea> </div>
                     <div class="form-group"> <label for="question-type">Tipo Pregunta:</label> <select class="form-control" id="question-type"><option value="multiple-choice" selected>Opción Múltiple</option><option value="true-false">Verdadero/Falso</option></select> </div>
                     <div class="form-row"> <div class="form-group col-md-3 col-sm-6" id="num-questions-group"> <label for="num-questions">Nº Preguntas:</label> <select class="form-control" id="num-questions"><option value="5">5</option><option value="10" selected>10</option><option value="15">15</option><option value="20">20</option><option value="25">25</option><option value="30">30</option><option value="40">40</option><option value="50">50</option></select> </div> <div class="form-group col-md-3 col-sm-6 om-option" id="num-answers-group"> <label for="num-answers">Nº Respuestas (OM):</label> <select class="form-control" id="num-answers" title="Nº respuestas Opción Múltiple"><option value="2">2</option><option value="3">3</option><option value="4" selected>4</option><option value="5">5</option></select> </div> <div class="form-group col-md-3 col-sm-6 om-option" id="allow-multiple-group"> <label for="allow-multiple">Múltiples Correctas (OM):</label> <select class="form-control" id="allow-multiple" title="Permitir múltiples correctas"><option value="false" selected>No</option><option value="true">Sí</option></select> </div> <div class="form-group col-md-3 col-sm-6 om-option" id="penalty-group"> <label for="penalty">Penalización (OM):</label> <select class="form-control" id="penalty" title="Penalización por incorrecta"><option value="0.0" selected>0%</option><option value="-1.0">-100%</option><option value="-0.5">-50%</option><option value="-0.3333333">-33.3%</option><option value="-0.25">-25%</option><option value="-0.20">-20%</option></select> </div> </div>
                     <button class="btn btn-primary btn-block" id="generate-gift"><i class="fas fa-magic mr-1"></i> Generar Banco de Preguntas GIFT</button>
                     <div id="loading-indicator" class="mt-3 text-center" style="display: none;"><i class="fas fa-spinner fa-spin fa-2x text-primary"></i><p class="mt-2">Generando preguntas...</p></div> <div id="error-message" class="alert alert-danger mt-3" role="alert" style="display: none;"></div>
                    <div class="download-buttons d-flex w-100"> <a id="download-all-button" class="btn btn-success flex-fill me-2" href="#" download="Preguntas.gift" style="display: none;"><i class="fas fa-file-download mr-1"></i> Descargar Todo</a> <a id="download-selected-button" class="btn btn-info flex-fill" href="#" style="display: none;"><i class="fas fa-check-square mr-1"></i> Descargar Selección</a> </div>
                    <div class="simulator-buttons"> <button class="btn btn-info flex-fill me-2" id="load-in-simulator-button" style="display: none;"><i class="fas fa-flask-vial mr-1"></i> Cargar Todo en Simulador</button> <button class="btn btn-warning flex-fill" id="load-selected-in-simulator-button" style="display: none;"><i class="fas fa-vial-circle-check mr-1"></i> Cargar Selección en Simulador</button> </div>
                    <div id="quiz-preview" class="mt-4" style="display: none;"> <hr> <h2 class="mb-3">Vista Previa de Preguntas</h2> <div id="questions-preview"></div> </div>
                </div>
            </div>

            <!-- Pestaña 2: Simulador GIFT (sin cambios HTML) -->
            <div class="tab-pane fade" id="simulator-tab" role="tabpanel" aria-labelledby="simulator-nav-tab">
                 <div class="container">
                    <h1 class="mb-4 text-center">Simulador de Cuestionario GIFT Moodle</h1>
                    <div id="upload-area"> <div id="drop-zone"><p>Arrastra tu archivo .gift aquí o haz clic</p><input type="file" id="gift-file-input" accept=".gift,.txt" style="display: none;"><button id="browse-button" class="btn btn-primary">Seleccionar Archivo</button></div> <div id="parse-error-message" class="alert alert-danger mt-2" style="display: none;"></div> <div id="file-info" class="text-muted small" style="display: none;"></div> </div>
                    <div id="quiz-display-area" style="display: none;"> <h2 id="quiz-title" class="mb-3">Cuestionario</h2> </div>
                    <div class="text-center mt-4"> <button id="submit-quiz-button" class="btn btn-success btn-lg" style="display: none;"><i class="fas fa-check-circle mr-1"></i> Enviar Intento y Corregir</button> </div>
                    <div id="quiz-results-area" style="display: none;"> <h3 class="mb-3">Resultados del Intento</h3> <div id="score-summary"></div> <div class="results-buttons mt-4"> <button id="retry-button" class="btn btn-info" style="display: none;"> <i class="fas fa-redo mr-1"></i> Repetir Cuestionario </button> <button id="reset-button" class="btn btn-secondary" style="display: none;"> <i class="fas fa-file-upload mr-1"></i> Cargar Otro Archivo </button> </div> </div>
                 </div>
            </div>
        </div>
    </div>

    <!-- ==================== SCRIPTS ==================== -->

    <!-- Script del GENERADOR GIFT -->
    <script>
        (function() { // IIFE Generador
            document.addEventListener('DOMContentLoaded', function () {
                // --- Variables Generador (igual) ---
                const loadInSimulatorButton = document.getElementById('load-in-simulator-button'); 
                const loadSelectedInSimulatorButton = document.getElementById('load-selected-in-simulator-button'); 
                const API_KEY = ""; // -- Poner tu API-KEY aquí --- 
                const apiKeyInput = document.getElementById('gemini-api-key');
                const showApiKeyButton = document.getElementById('show-api-key');
                const geminiModelSelect = document.getElementById('gemini-model-select');
                const modelLoadingIndicator = document.getElementById('model-loading-indicator');
                const modelErrorMessage = document.getElementById('model-error-message'); const quizTopicInput = document.getElementById('quiz-topic'); const generateGiftButton = document.getElementById('generate-gift'); const loadingIndicator = document.getElementById('loading-indicator'); const errorMessage = document.getElementById('error-message'); const downloadAllButton = document.getElementById('download-all-button'); const downloadSelectedButton = document.getElementById('download-selected-button'); const quizPreviewDiv = document.getElementById('quiz-preview'); const questionsPreview = document.getElementById('questions-preview'); const numQuestionsSelect = document.getElementById('num-questions'); const questionTypeSelect = document.getElementById('question-type'); const numAnswersSelect = document.getElementById('num-answers'); const allowMultipleSelect = document.getElementById('allow-multiple'); const penaltySelect = document.getElementById('penalty'); const numQuestionsGroup = document.getElementById('num-questions-group'); const numAnswersGroup = document.getElementById('num-answers-group'); const allowMultipleGroup = document.getElementById('allow-multiple-group'); const penaltyGroup = document.getElementById('penalty-group'); const omOptions = [numAnswersGroup, allowMultipleGroup, penaltyGroup]; let giftCodeGlobal = "";

                // --- Funciones Generador ---
                function updateOptionVisibility() { /* ... sin cambios ... */ const selectedType = questionTypeSelect.value; if (selectedType === 'true-false') { omOptions.forEach(el => el.style.display = 'none'); numQuestionsGroup.classList.remove('col-md-3', 'col-sm-6'); numQuestionsGroup.classList.add('col-12'); } else { omOptions.forEach(el => el.style.display = 'block'); numQuestionsGroup.classList.remove('col-12'); numQuestionsGroup.classList.add('col-md-3', 'col-sm-6'); } } questionTypeSelect.addEventListener('change', updateOptionVisibility); updateOptionVisibility();
                async function loadModels(apiKeyToUse) {
                    geminiModelSelect.innerHTML = '<option value="">Ingresa API Key...</option>'; geminiModelSelect.disabled = true; modelErrorMessage.style.display = 'none'; modelLoadingIndicator.style.display = 'none';
                    const trimmedKey = apiKeyToUse ? apiKeyToUse.trim() : '';
                    if (!trimmedKey) { geminiModelSelect.innerHTML = '<option value="">Ingresa API Key válida...</option>'; geminiModelSelect.disabled = true; return; }
                    modelLoadingIndicator.style.display = 'block';
                    try {
                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${trimmedKey}`);
                        if (!response.ok) { let errorMsg = `Error ${response.status}`; try { const errorData = await response.json(); errorMsg = errorData.error?.message || `Error API (${response.status})`; } catch (e) { errorMsg = `Error ${response.status} al verificar API Key.`; } throw new Error(errorMsg); }
                        const data = await response.json(); geminiModelSelect.innerHTML = '<option value="">-- Selecciona modelo --</option>';
                        let defaultModelFound = false;
                        const preferredModelName = "gemini-2.0-flash"; // Modelo exacto que buscamos

                        if (data.models && data.models.length > 0) {
                            const compatibleModels = data.models.filter(model => model.supportedGenerationMethods?.includes("generateContent"));
                            if (compatibleModels.length > 0) {
                                compatibleModels.sort((a, b) => (a.displayName || a.name).localeCompare(b.displayName || b.name))
                                .forEach(model => {
                                    const option = document.createElement('option');
                                    option.value = model.name; // e.g., "models/gemini-1.5-flash-latest"
                                    option.textContent = model.displayName || model.name;

                                    // *** LÍNEA MODIFICADA: Comprobación exacta ***
                                    if (model.name === 'models/' + preferredModelName) {
                                        option.selected = true;
                                        defaultModelFound = true;
                                    }
                                    // *** FIN LÍNEA MODIFICADA ***

                                    geminiModelSelect.appendChild(option);
                                });
                                geminiModelSelect.disabled = false;
                                if (!defaultModelFound && geminiModelSelect.options.length > 1) {
                                    geminiModelSelect.selectedIndex = 1;
                                }
                            } else { /* ... error no compatibles ... */ geminiModelSelect.innerHTML = '<option value="">No hay modelos compatibles</option>'; throw new Error("API Key válida, pero sin modelos compatibles ('generateContent')."); }
                        } else { /* ... error no modelos ... */ geminiModelSelect.innerHTML = '<option value="">No se encontraron modelos</option>'; throw new Error("API Key válida, pero no se devolvieron modelos."); }
                    } catch (error) { /* ... manejo de error ... */ console.error("Error cargando modelos:", error); modelErrorMessage.textContent = `Error: ${error.message}`; modelErrorMessage.style.display = 'block'; geminiModelSelect.innerHTML = '<option value="">Error</option>'; geminiModelSelect.disabled = true; }
                    finally { modelLoadingIndicator.style.display = 'none'; }
                } // Fin loadModels modificado

                // --- Resto de funciones y listeners del generador (sin cambios) ---
                if (API_KEY && API_KEY.trim() !== '') { apiKeyInput.value = API_KEY; loadModels(API_KEY); } apiKeyInput.addEventListener('blur', () => { loadModels(apiKeyInput.value); }); showApiKeyButton.addEventListener('click', () => { const isPassword = apiKeyInput.type === "password"; apiKeyInput.type = isPassword ? "text" : "password"; showApiKeyButton.innerHTML = isPassword ? '<i class="fas fa-eye-slash"></i>' : '<i class="fas fa-eye"></i>'; });
                function buildPayload(prompt) { /* ... sin cambios ... */ return JSON.stringify({ "contents": [ { "parts": [ { "text": prompt } ] } ], "generationConfig": { "temperature": 0.6, "maxOutputTokens": 8192, "topP": 0.95, "topK": 40 }, "safetySettings": [ { "category": "HARM_CATEGORY_HARASSMENT", "threshold": "BLOCK_MEDIUM_AND_ABOVE" }, { "category": "HARM_CATEGORY_HATE_SPEECH", "threshold": "BLOCK_MEDIUM_AND_ABOVE" }, { "category": "HARM_CATEGORY_SEXUALLY_EXPLICIT", "threshold": "BLOCK_MEDIUM_AND_ABOVE" }, { "category": "HARM_CATEGORY_DANGEROUS_CONTENT", "threshold": "BLOCK_MEDIUM_AND_ABOVE" } ] }); } async function callGeminiAPI(payload) { /* ... sin cambios ... */ const currentApiKey = apiKeyInput.value.trim(); const selectedModelName = geminiModelSelect.value; if (!currentApiKey) throw new Error("Ingresa tu clave API."); if (!selectedModelName) throw new Error("Selecciona un modelo Gemini."); const apiUrl = `https://generativelanguage.googleapis.com/v1beta/${selectedModelName}:generateContent?key=${currentApiKey}`; try { const response = await fetch(apiUrl, { method: "POST", headers: { "Content-Type": "application/json" }, body: payload }); if (!response.ok) { let errorMsg = `Error ${response.status}`; try { const errorData = await response.json(); errorMsg = `Error API: ${errorData.error?.message || `(${response.status})`}`; } catch { /* ignore */ } throw new Error(errorMsg); } return await response.json(); } catch (error) { console.error("Error en callGeminiAPI:", error); throw new Error(`Fallo API Gemini: ${error.message}`); } } function extractResponse(response) { /* ... sin cambios ... */ if (response?.promptFeedback?.blockReason) { console.error("API Block:", response.promptFeedback.blockReason); throw new Error(`Solicitud bloqueada por API: ${response.promptFeedback.blockReason}. Ajusta el tema.`); } if (response?.candidates?.[0]?.content?.parts?.[0]?.text) { return response.candidates[0].content.parts[0].text; } if (response?.candidates?.[0]?.finishReason && response.candidates[0].finishReason !== "STOP") { console.warn("API Finish:", response.candidates[0].finishReason); throw new Error(`Generación incompleta (Razón: ${response.candidates[0].finishReason}).`); } throw new Error("Respuesta API inesperada o vacía."); }
                async function generateGIFT(quizTopic, numQuestions, questionType, numAnswers, allowMultiple, penalty) { /* ... código generateGIFT igual ... */ let prompt = `Eres experto en GIFT Moodle.\nTema: "${quizTopic}"\nNº Preguntas: ${numQuestions}\nTipo: ${questionType === 'true-false' ? 'V/F' : 'Opción Múltiple'}\n\n**REGLAS GENERALES OBLIGATORIAS:**\n1. Formato GIFT Exacto.\n2. Título '::Título::'.\n3. Enunciado claro.\n4. Respuesta en '{ }'.\n5. UNA línea en blanco entre preguntas.\n6. SIN texto extra.\n7. SIN HTML/Markdown.\n\n**REGLAS ESPECÍFICAS:**\n`; if (questionType === 'true-false') { prompt += `**V/F:**\n * Enunciado afirmación.\n * Respuesta '{T}' o '{F}'.\n * Feedback opcional con '#': '{T#Feedback}' o '{F#Feedback}'.\n * NO usar '~', '=', '%'.\n Ejemplo:\n ::Ej V/F 1:: La luna es queso. {F#Es roca.}\n\n ::Ej V/F 2:: 2+2=4. {T#Correcto.}\n`; } else { const penaltyPercentage = (penalty * 100).toFixed(1); prompt += `**OPCIÓN MÚLTIPLE:**\n * Opciones: ${numAnswers}.\n * Marcadores: Correcta '=', incorrectas '~'.\n * Feedback OBLIGATORIO con '#'.\n * Penalización incorrectas (~): ~%${penaltyPercentage}%Texto #Feedback.\n`; if (allowMultiple === "true") { prompt += ` * Múltiples Correctas (=) permitidas (AL MENOS DOS).\n * Puntuación Parcial OBLIGATORIA en correctas: '=%PORCENTAJE%Texto #Feedback'. Suma debe ser 100%.\n Ejemplo Múltiple (Penalización ${penaltyPercentage}%):\n ::Colores Primarios:: ¿Cuáles son colores primarios (luz)? {\n =%33.3%Rojo #Correcto.\n ~%${penaltyPercentage}%Amarillo #Incorrecto (pigmento).\n =%33.3%Verde #Correcto.\n =%33.3%Azul #Correcto.\n }\n`; } else { prompt += ` * Única Correcta (=).\n Ejemplo Única (Penalización ${penaltyPercentage}%):\n ::Planeta Rojo:: ¿Qué planeta es rojo? {\n ~%${penaltyPercentage}%Venus #No.\n =Marte #Sí.\n ~%${penaltyPercentage}%Júpiter #No.\n ~%${penaltyPercentage}%Saturno #No.\n }\n`; } prompt += ` * Variar posición correcta.\n`; } prompt += `\n**INSTRUCCIÓN FINAL:**\nGenera EXACTAMENTE ${numQuestions} preguntas del tipo solicitado sobre "${quizTopic}" siguiendo ESTRICTAMENTE las reglas. GENERAR AHORA:\n`; const payload = buildPayload(prompt); const apiResponse = await callGeminiAPI(payload); let giftCode = extractResponse(apiResponse); giftCode = giftCode.replace(/```gift/gi, "").replace(/```/g, "").replace(/^\s*[\r\n]/, '').replace(/[\r\n]\s*$/, '').replace(/[\r\n]{3,}/g, '\n\n'); giftCodeGlobal = giftCode; return giftCode;}
                function displayQuestions(giftCode) { /* ... código displayQuestions igual ... */ questionsPreview.innerHTML = ''; quizPreviewDiv.style.display = 'none'; let questionCounter = 0; let parseErrors = 0; if (!giftCode || giftCode.trim() === "") { questionsPreview.innerHTML = '<p class="text-muted text-center">No se generaron preguntas.</p>'; quizPreviewDiv.style.display = 'block'; return 0; } const questionBlocks = giftCode.split('\n\n'); questionBlocks.forEach((questionBlock, index) => { const question = questionBlock.trim(); if (question === "") return; const questionContainer = document.createElement('div'); questionContainer.className = 'question-container'; questionContainer.dataset.questionIndex = index; const checkbox = document.createElement('input'); checkbox.type = 'checkbox'; checkbox.className = 'question-checkbox'; questionContainer.appendChild(checkbox); questionContainer.addEventListener('click', (e) => { if (e.target === questionContainer || e.target.closest('.question-container') === questionContainer && !e.target.closest('a, button')) { checkbox.checked = !checkbox.checked; questionContainer.classList.toggle('selected', checkbox.checked); } }); try { const titleMatch = question.match(/^::(.*?)::/); const titleText = titleMatch ? titleMatch[1].trim() : `Pregunta ${index + 1} (Sin Título)`; const questionBodyMatch = question.match(/^::.*?::\s*([\s\S]*?)\s*\{([\s\S]*?)\}\s*$/); if (!questionBodyMatch) throw new Error("Estructura GIFT básica no encontrada."); const questionText = questionBodyMatch[1].trim(); const optionsText = questionBodyMatch[2].trim(); questionCounter++; const questionTitleEl = document.createElement('h5'); questionTitleEl.textContent = titleText; questionContainer.appendChild(questionTitleEl); const questionParagraph = document.createElement('p'); const tempDiv = document.createElement('div'); tempDiv.textContent = questionText; questionParagraph.innerHTML = `<b>${tempDiv.innerHTML}</b>`; questionContainer.appendChild(questionParagraph); const optionsList = document.createElement('ul'); optionsList.className = 'list-unstyled'; const upperOptionsText = optionsText.toUpperCase(); let isTrueFalse = false; let tfAnswer = ''; let tfFeedback = ''; if (upperOptionsText === 'T' || upperOptionsText === 'F') { isTrueFalse = true; tfAnswer = upperOptionsText; } else if (upperOptionsText.startsWith('T#')) { isTrueFalse = true; tfAnswer = 'T'; tfFeedback = optionsText.substring(2).trim(); } else if (upperOptionsText.startsWith('F#')) { isTrueFalse = true; tfAnswer = 'F'; tfFeedback = optionsText.substring(2).trim(); } if (isTrueFalse) { const optionItem = document.createElement('li'); optionItem.className = 'answer-option'; let displayHtml = ''; if (tfAnswer === 'T') { displayHtml = '<i class="fas fa-check text-success mr-2" title="Correcta: Verdadero"></i> Verdadero'; } else { displayHtml = '<i class="fas fa-times text-danger mr-2" title="Correcta: Falso"></i> Falso'; } if (tfFeedback) { tempDiv.textContent = tfFeedback; displayHtml += ` <small class="feedback-text ml-2">(${tempDiv.innerHTML})</small>`; } optionItem.innerHTML = displayHtml; optionsList.appendChild(optionItem); } else { const optionLines = optionsText.split('\n').map(line => line.trim()).filter(line => line.startsWith('=') || line.startsWith('~')); if (optionLines.length === 0) throw new Error("No se encontraron opciones '=' o '~'."); optionLines.forEach(line => { const optionItem = document.createElement('li'); optionItem.className = 'answer-option'; const symbol = line.charAt(0); let rest = line.substring(1).trim(); let percentage = ""; let feedback = ""; let text = rest; const feedbackMatch = rest.match(/^(.*?)#(.*)$/); if (feedbackMatch) { text = feedbackMatch[1].trim(); feedback = feedbackMatch[2].trim(); } else { text = rest; } const percentageMatch = text.match(/^%(.*?)%(.*)$/); if (percentageMatch) { percentage = percentageMatch[1].trim(); text = percentageMatch[2].trim(); } let displayHtml = (symbol === '=') ? '<i class="fas fa-check text-success mr-2" title="Opción Correcta"></i>' : '<i class="fas fa-times text-danger mr-2" title="Opción Incorrecta"></i>'; tempDiv.textContent = text; displayHtml += tempDiv.innerHTML; if (percentage) { displayHtml += ` <span class="badge badge-info" title="Puntuación/Penalización">${percentage}%</span>`; } else if (symbol === '~' && !percentage && parseFloat(penaltySelect.value) !== 0.0 && questionTypeSelect.value === 'multiple-choice') { displayHtml += ` <span class="badge badge-warning" title="Penalización Implícita">${(parseFloat(penaltySelect.value) * 100).toFixed(1)}%</span>`; } if (feedback) { tempDiv.textContent = feedback; displayHtml += ` <small class="feedback-text ml-2">(${tempDiv.innerHTML})</small>`; } optionItem.innerHTML = displayHtml; optionsList.appendChild(optionItem); }); } questionContainer.appendChild(optionsList); questionsPreview.appendChild(questionContainer); } catch (parseError) { console.warn(`Error parseando bloque ${index}: "${questionBlock}"`, parseError); parseErrors++; const errorContainer = document.createElement('div'); errorContainer.className = 'question-container'; errorContainer.style.borderColor = 'red'; errorContainer.style.backgroundColor = '#f8d7da'; errorContainer.style.cursor = 'default'; errorContainer.dataset.questionIndex = index; const errorTitle = document.createElement('h5'); const titleMatch = questionBlock.match(/^::(.*?)::/); errorTitle.textContent = titleMatch ? titleMatch[1].trim() : `Pregunta ${index + 1} (Error Formato)`; errorContainer.appendChild(errorTitle); const errorP = document.createElement('p'); errorP.className = 'text-danger small mt-2'; errorP.textContent = `Error: ${parseError.message}`; errorContainer.appendChild(errorP); const codeBlock = document.createElement('pre'); codeBlock.textContent = questionBlock; codeBlock.style.cssText = 'font-size:0.8em; white-space:pre-wrap; background-color:#f1f1f1; padding:10px; margin-top:5px; border:1px dashed #dc3545;'; errorContainer.appendChild(codeBlock); questionsPreview.appendChild(errorContainer); } }); quizPreviewDiv.style.display = 'block'; if (parseErrors > 0) { const errorSummary = document.createElement('p'); errorSummary.className = 'alert alert-warning small'; errorSummary.innerHTML = `<strong>Atención:</strong> ${parseErrors} ${parseErrors === 1 ? 'pregunta' : 'preguntas'} con formato inválido (rojo).`; questionsPreview.insertBefore(errorSummary, questionsPreview.firstChild); } return questionCounter; }
                generateGiftButton.addEventListener('click', async () => { errorMessage.style.display = 'none'; errorMessage.textContent = ''; loadingIndicator.style.display = 'block'; downloadAllButton.style.display = 'none'; downloadSelectedButton.style.display = 'none'; loadInSimulatorButton.style.display = 'none'; loadSelectedInSimulatorButton.style.display = 'none'; quizPreviewDiv.style.display = 'none'; questionsPreview.innerHTML = ''; downloadAllButton.textContent = ''; const iconAll = document.createElement('i'); iconAll.className = 'fas fa-file-download mr-1'; downloadAllButton.appendChild(iconAll); downloadAllButton.appendChild(document.createTextNode(' Descargar Todo')); const quizTopic = quizTopicInput.value.trim(); const numQuestionsRequested = numQuestionsSelect.value; const questionType = questionTypeSelect.value; const numAnswers = numAnswersSelect.value; const allowMultiple = allowMultipleSelect.value; const penalty = parseFloat(penaltySelect.value); if (!quizTopic) { errorMessage.textContent = "Ingresa descripción del tema."; errorMessage.style.display = 'block'; loadingIndicator.style.display = 'none'; return; } if (!apiKeyInput.value.trim()) { errorMessage.textContent = "Ingresa tu clave API."; errorMessage.style.display = 'block'; loadingIndicator.style.display = 'none'; return; } if (!geminiModelSelect.value) { errorMessage.textContent = "Selecciona un modelo Gemini."; errorMessage.style.display = 'block'; loadingIndicator.style.display = 'none'; return; } try { const giftCode = await generateGIFT(quizTopic, numQuestionsRequested, questionType, numAnswers, allowMultiple, penalty); const validQuestionsCount = displayQuestions(giftCode); if (giftCode.trim() !== "" && validQuestionsCount > 0) { const blobAll = new Blob([giftCode], { type: 'text/plain;charset=utf-8' }); const urlAll = URL.createObjectURL(blobAll); downloadAllButton.href = urlAll; downloadAllButton.download = `Preguntas_${validQuestionsCount}.gift`; downloadAllButton.style.display = 'inline-block'; downloadSelectedButton.style.display = 'inline-block'; loadInSimulatorButton.style.display = 'inline-block'; loadSelectedInSimulatorButton.style.display = 'inline-block'; } else if (validQuestionsCount === 0 && giftCode.trim() !== "") { errorMessage.textContent = "Se generó código, pero ninguna pregunta pudo ser interpretada."; errorMessage.style.display = 'block'; const blobAll = new Blob([giftCode], { type: 'text/plain;charset=utf-8' }); const urlAll = URL.createObjectURL(blobAll); downloadAllButton.href = urlAll; downloadAllButton.download = `Preguntas_raw_errores.gift`; downloadAllButton.textContent = ''; const iconError = document.createElement('i'); iconError.className = 'fas fa-exclamation-triangle mr-1'; downloadAllButton.appendChild(iconError); downloadAllButton.appendChild(document.createTextNode(' Descargar Código (con errores)')); downloadAllButton.style.display = 'inline-block'; downloadSelectedButton.style.display = 'none'; loadInSimulatorButton.style.display = 'none'; loadSelectedInSimulatorButton.style.display = 'none'; } } catch (error) { console.error("Error generación:", error); errorMessage.textContent = `Error: ${error.message}`; errorMessage.style.display = 'block'; quizPreviewDiv.style.display = 'none'; } finally { loadingIndicator.style.display = 'none'; } });
                downloadSelectedButton.addEventListener('click', (event) => { /* ... sin cambios ... */ event.preventDefault(); let selectedQuestionsGIFT = []; const allQuestionBlocks = giftCodeGlobal.split('\n\n'); const displayedValidContainers = questionsPreview.querySelectorAll('.question-container:not([style*="border-color: red"])'); displayedValidContainers.forEach(container => { const checkbox = container.querySelector('.question-checkbox'); const originalIndex = container.dataset.questionIndex; if (checkbox?.checked && originalIndex !== undefined && allQuestionBlocks[originalIndex]) { selectedQuestionsGIFT.push(allQuestionBlocks[originalIndex].trim()); } }); if (selectedQuestionsGIFT.length === 0) { alert("No has seleccionado preguntas válidas."); return; } const selectedGiftCode = selectedQuestionsGIFT.join('\n\n'); const blob = new Blob([selectedGiftCode], { type: 'text/plain;charset=utf-8' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `Preguntas_Seleccionadas_${selectedQuestionsGIFT.length}.gift`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); });
                loadInSimulatorButton.addEventListener('click', () => { if (giftCodeGlobal && giftCodeGlobal.trim() !== '') { if (typeof window.loadSimulatorWithGIFT === 'function') { window.loadSimulatorWithGIFT(giftCodeGlobal); $('#simulator-nav-tab').tab('show'); } else { console.error("Error: La función loadSimulatorWithGIFT no está definida."); alert("Error al cargar en simulador."); } } else { alert("Primero genera preguntas."); } });
                loadSelectedInSimulatorButton.addEventListener('click', () => { /* ... código carga selección igual ... */ let selectedQuestionsGIFT = []; const allQuestionBlocks = giftCodeGlobal.split('\n\n'); const displayedValidContainers = questionsPreview.querySelectorAll('.question-container:not([style*="border-color: red"])'); displayedValidContainers.forEach(container => { const checkbox = container.querySelector('.question-checkbox'); const originalIndex = container.dataset.questionIndex; if (checkbox?.checked && originalIndex !== undefined && allQuestionBlocks[originalIndex]) { selectedQuestionsGIFT.push(allQuestionBlocks[originalIndex].trim()); } }); if (selectedQuestionsGIFT.length === 0) { alert("No has seleccionado preguntas válidas para cargar."); return; } const selectedGiftCode = selectedQuestionsGIFT.join('\n\n'); if (typeof window.loadSimulatorWithGIFT === 'function') { window.loadSimulatorWithGIFT(selectedGiftCode, `Selección de ${selectedQuestionsGIFT.length} preguntas`); $('#simulator-nav-tab').tab('show'); } else { console.error("Error: La función loadSimulatorWithGIFT no está definida."); alert("Error al cargar la selección."); } });
            });
        })();
    </script>

    <!-- Script del SIMULADOR GIFT -->
     <script>
        (function() { // IIFE Simulador
            let simSubmissionMade = false;
            let simParsedQuestions = [];
            function getSimElement(id) { const simulatorTab = document.getElementById('simulator-tab'); if (!simulatorTab) { console.error(`Error crítico: No se encontró #simulator-tab.`); return null; } const element = simulatorTab.querySelector(`#${id}`); return element; }

            document.addEventListener('DOMContentLoaded', () => {
                const simDropZone = getSimElement('drop-zone'); const simFileInput = getSimElement('gift-file-input'); const simBrowseButton = getSimElement('browse-button'); const simQuizDisplayArea = getSimElement('quiz-display-area'); const simSubmitButton = getSimElement('submit-quiz-button'); const simResultsArea = getSimElement('quiz-results-area'); const simScoreSummary = getSimElement('score-summary'); const simUploadArea = getSimElement('upload-area'); const simParseErrorMessage = getSimElement('parse-error-message'); const simFileInfo = getSimElement('file-info'); const simQuizTitle = getSimElement('quiz-title'); const simResetButton = getSimElement('reset-button'); const simRetryButton = getSimElement('retry-button');
                if (!simDropZone || !simFileInput || !simBrowseButton || !simSubmitButton || !simResetButton || !simRetryButton) { console.error("Error: Faltan elementos DOM del simulador."); return; }

                // --- Funciones Simulador (sin cambios) ---
                simBrowseButton.addEventListener('click', () => simFileInput.click()); simFileInput.addEventListener('change', simHandleFileSelect); simDropZone.addEventListener('dragover', (e) => { e.preventDefault(); e.stopPropagation(); simDropZone.classList.add('dragover'); }); simDropZone.addEventListener('dragleave', (e) => { e.preventDefault(); e.stopPropagation(); simDropZone.classList.remove('dragover'); }); simDropZone.addEventListener('drop', (e) => { e.preventDefault(); e.stopPropagation(); simDropZone.classList.remove('dragover'); const files = e.dataTransfer.files; if (files.length > 0) simHandleFile(files[0]); });
                function simHandleFileSelect(event) { if (event.target.files.length > 0) simHandleFile(event.target.files[0]); }
                function simHandleFile(file) { if (!file.name.endsWith('.gift') && !file.name.endsWith('.txt')) { simShowParseError("Selecciona archivo .gift o .txt."); return; } const reader = new FileReader(); reader.onload = (e) => { loadGIFTFromString(e.target.result, `Archivo: ${file.name}`); }; reader.onerror = (e) => { console.error("Sim Error leyendo:", e); simShowParseError("Error al leer archivo."); simResetUI(); }; reader.readAsText(file); }
                function loadGIFTFromString(giftText, sourceInfo = "Cargado desde Generador") { if (!simQuizDisplayArea || !simSubmitButton || !simResultsArea || !simScoreSummary || !simUploadArea || !simParseErrorMessage || !simFileInfo || !simQuizTitle || !simResetButton || !simRetryButton) { console.error("Error en loadGIFTFromString: Faltan elementos DOM."); alert("Error interno al cargar."); return; } try { simParsedQuestions = simParseGIFT(giftText); if (simParsedQuestions.length === 0) { simShowParseError("Texto GIFT vacío o sin preguntas."); return; } simHideParseError(); simFileInfo.textContent = `${sourceInfo} (${simParsedQuestions.length} preguntas)`; simFileInfo.style.display = 'block'; simSubmissionMade = false; simSubmitButton.disabled = false; simSubmitButton.innerHTML = '<i class="fas fa-check-circle mr-1"></i> Enviar Intento y Corregir'; simResultsArea.style.display = 'none'; simScoreSummary.innerHTML = ''; const resultsButtonsContainer = simResultsArea.querySelector('.results-buttons'); if (resultsButtonsContainer) resultsButtonsContainer.style.display = 'none'; else console.warn("No se encontró .results-buttons"); simRetryButton.style.display = 'none'; simResetButton.style.display = 'none'; simRenderQuiz(simParsedQuestions); simUploadArea.style.display = 'none'; simQuizDisplayArea.style.display = 'block'; simSubmitButton.style.display = 'block'; } catch (error) { console.error("Sim Error procesando GIFT:", error); simShowParseError(`Error procesando GIFT: ${error.message}.`); simResetUI(); } }
                window.loadSimulatorWithGIFT = loadGIFTFromString; // Exponer globalmente
                function simShowParseError(message) { if(simParseErrorMessage){ simParseErrorMessage.textContent = message; simParseErrorMessage.style.display = 'block'; } if(simFileInfo) simFileInfo.style.display = 'none'; } function simHideParseError() { if(simParseErrorMessage) simParseErrorMessage.style.display = 'none'; }
                function simParseGIFT(giftText) { /* ... sin cambios ... */ const questions = []; const blocks = giftText.replace(/\r\n/g, '\n').split(/\n\n+/); let parseErrorsCount = 0; blocks.forEach((block, index) => { block = block.trim(); if (!block || block.startsWith('//')) return; const question = { id: `sim-q${index}`, title: `Pregunta ${index + 1}`, text: '', type: '', options: [], raw: block, feedback: { correct: '', incorrect: '' }, score: 0, intermediateScore: 0, calculationSteps: [] }; try { const titleMatch = block.match(/^::(.*?)::/); if (titleMatch) { question.title = titleMatch[1].trim(); block = block.substring(titleMatch[0].length).trim(); } const bodyMatch = block.match(/^(.*?)\{([\s\S]*)\}$/s); if (!bodyMatch) throw new Error("Falta 'Enunciado { Opciones }'."); question.text = bodyMatch[1].trim().replace(/\\([{}~=#:])/g, '$1'); const optionsString = bodyMatch[2].trim(); const upperOptionsTrimmed = optionsString.toUpperCase().trim(); if (upperOptionsTrimmed === 'T' || upperOptionsTrimmed === 'F' || upperOptionsTrimmed.startsWith('T#') || upperOptionsTrimmed.startsWith('F#')) { question.type = 'tf'; let answer = ''; let feedback = ''; if (upperOptionsTrimmed.startsWith('T')) { answer = 'T'; if (upperOptionsTrimmed.startsWith('T#')) feedback = optionsString.substring(2).trim(); } else { answer = 'F'; if (upperOptionsTrimmed.startsWith('F#')) feedback = optionsString.substring(2).trim(); } question.options.push({ text: 'Verdadero', correct: (answer === 'T'), feedback: (answer === 'T' ? feedback : ''), percentage: null }); question.options.push({ text: 'Falso', correct: (answer === 'F'), feedback: (answer === 'F' ? feedback : ''), percentage: null }); } else { question.type = 'mc'; let correctCount = 0; const optionLines = optionsString.split('\n').map(l => l.trim()).filter(l => l.startsWith('=') || l.startsWith('~')); if (optionLines.length === 0) throw new Error("Faltan opciones (= o ~)."); optionLines.forEach(line => { const option = { text: '', correct: false, feedback: '', percentage: null }; const marker = line.charAt(0); option.correct = (marker === '='); if (option.correct) correctCount++; let content = line.substring(1).trim(); const feedbackMatch = content.match(/^(.*?)#(.*)$/); if (feedbackMatch) { content = feedbackMatch[1].trim(); option.feedback = feedbackMatch[2].trim().replace(/\\([{}~=#:])/g, '$1'); } let rawPercentage = null; const percentMatch = content.match(/^%(.*?)%(.*)$/); if (percentMatch) { rawPercentage = parseFloat(percentMatch[1].trim()); content = percentMatch[2].trim(); option.percentage = rawPercentage; } option.text = content.replace(/\\([{}~=#:])/g, '$1'); question.options.push(option); }); if (correctCount > 1) question.type = 'mc_multi'; else if (correctCount === 1) question.type = 'mc_single'; else { console.warn(`Sim Pregunta ${question.title} sin correcta (=).`); question.type = 'mc_single'; } } questions.push(question); } catch (error) { parseErrorsCount++; console.warn(`Sim Error bloque ${index + 1} ('${question.title}'): ${error.message}\n${question.raw}`); } }); if (parseErrorsCount > 0) console.warn(`Sim ${parseErrorsCount} errores parseo.`); return questions; }
                function simRenderQuiz(questions) { /* ... sin cambios ... */ if (!simQuizDisplayArea || !simQuizTitle) return; simQuizDisplayArea.innerHTML = ''; simQuizTitle.textContent = `Cuestionario (${questions.length} preguntas)`; questions.forEach((q, index) => { const card = document.createElement('div'); card.className = 'card question-card'; card.id = q.id; const header = document.createElement('div'); header.className = 'question-header header-unanswered'; header.innerHTML = `<span class="question-number">Pregunta ${index + 1}</span><span class="question-status status-unanswered" id="status-${q.id}">Sin responder</span>`; card.appendChild(header); const body = document.createElement('div'); body.className = 'question-body'; const textP = document.createElement('div'); textP.className = 'question-text'; textP.innerHTML = q.text; body.appendChild(textP); const optionsDiv = document.createElement('div'); optionsDiv.className = 'answer-options'; const inputType = (q.type === 'mc_multi') ? 'checkbox' : 'radio'; q.options.forEach((opt, optIndex) => { const optionId = `${q.id}-opt${optIndex}`; const wrapper = document.createElement('div'); wrapper.className = 'option-wrapper'; const input = document.createElement('input'); input.type = inputType; input.name = q.id; input.value = optIndex; input.id = optionId; input.disabled = false; const label = document.createElement('label'); label.htmlFor = optionId; label.innerHTML = opt.text; input.addEventListener('change', simHandleAnswerChange); wrapper.appendChild(input); wrapper.appendChild(label); optionsDiv.appendChild(wrapper); }); body.appendChild(optionsDiv); const feedbackDiv = document.createElement('div'); feedbackDiv.id = `feedback-${q.id}`; feedbackDiv.className = 'general-feedback'; feedbackDiv.style.display = 'none'; body.appendChild(feedbackDiv); card.appendChild(body); simQuizDisplayArea.appendChild(card); }); }
                function simHandleAnswerChange(event) { /* ... sin cambios ... */ if (simSubmissionMade) return; const changedInput = event.target; const questionId = changedInput.name; const statusSpan = document.getElementById(`status-${questionId}`); if (!statusSpan) return; const questionHeader = statusSpan.closest('.question-header'); if (!questionHeader) return; const allOptionsForQuestion = document.querySelectorAll(`input[name="${questionId}"]`); const isAnyOptionChecked = Array.from(allOptionsForQuestion).some(inp => inp.checked); statusSpan.className = 'question-status'; questionHeader.className = 'question-header'; if (isAnyOptionChecked) { statusSpan.textContent = 'Respuesta guardada'; statusSpan.classList.add('status-answered'); questionHeader.classList.add('header-answered'); } else { statusSpan.textContent = 'Sin responder'; statusSpan.classList.add('status-unanswered'); questionHeader.classList.add('header-unanswered'); } }
                simSubmitButton.addEventListener('click', () => { /* ... código corrección sin cambios ... */ if (simSubmissionMade) return; let finalTotalScore = 0; const maxScore = simParsedQuestions.length; let correctQuestions = 0; let partiallyCorrectQuestions = 0; let incorrectQuestions = 0; let unansweredQuestions = 0; simParsedQuestions.forEach((q, index) => { const questionCard = document.getElementById(q.id); if (!questionCard) return; const optionsContainer = questionCard.querySelector('.answer-options'); const inputs = optionsContainer.querySelectorAll(`input[name="${q.id}"]`); const statusSpan = document.getElementById(`status-${q.id}`); const questionHeader = statusSpan.closest('.question-header'); const feedbackDiv = document.getElementById(`feedback-${q.id}`); feedbackDiv.innerHTML = ''; feedbackDiv.className = 'general-feedback'; feedbackDiv.style.display = 'none'; let intermediateQuestionScore = 0; let userAnswerIndices = []; let answered = false; q.calculationSteps = []; inputs.forEach((input, optIndex) => { const wrapper = input.closest('.option-wrapper'); wrapper.classList.remove('correct-answer-mark', 'user-incorrect-selection'); wrapper.style.borderLeftColor = 'transparent'; const label = wrapper.querySelector('label'); label.title = ''; const existingFeedbackIcon = label.querySelector('.feedback-icon'); if (existingFeedbackIcon) label.removeChild(existingFeedbackIcon); const existingSpecificFeedback = questionCard.querySelector(`#specific-feedback-${q.id}-${optIndex}`); if (existingSpecificFeedback) existingSpecificFeedback.remove(); if (input.checked) { userAnswerIndices.push(optIndex); answered = true; } input.disabled = true; }); statusSpan.className = 'question-status'; questionHeader.className = 'question-header'; if (!answered) { unansweredQuestions++; statusSpan.textContent = 'Sin responder'; statusSpan.classList.add('status-unanswered'); questionHeader.classList.add('header-unanswered'); intermediateQuestionScore = 0; q.calculationSteps.push({value: 0, text: "Sin responder"}); } else { if (q.type === 'tf' || q.type === 'mc_single') { const selectedIndex = userAnswerIndices[0]; const opt = q.options[selectedIndex]; let stepValue = 0; let stepText = ""; if (opt.correct) { stepValue = 1.0; stepText = `+100% (Opción ${selectedIndex + 1} correcta)`; } else { if (opt.percentage !== null && opt.percentage < 0) { stepValue = opt.percentage / 100.0; stepText = `${opt.percentage}% (Opción ${selectedIndex + 1} incorrecta - penalización)`; } else { stepValue = 0.0; stepText = `0% (Opción ${selectedIndex + 1} incorrecta)`; } } intermediateQuestionScore = stepValue; q.calculationSteps.push({ value: stepValue, text: stepText }); } else { const totalCorrectOptions = q.options.filter(opt => opt.correct).length; let specifiedCorrectWeightSum = 0; q.options.filter(opt => opt.correct && opt.percentage !== null && opt.percentage > 0).forEach(opt => specifiedCorrectWeightSum += opt.percentage); q.options.forEach((opt, optIndex) => { const isSelected = userAnswerIndices.includes(optIndex); let stepValue = 0; let stepText = ""; if (isSelected) { if (opt.correct) { if (opt.percentage !== null && opt.percentage > 0) { stepValue = opt.percentage / 100.0; stepText = `+${opt.percentage}% (Opción ${optIndex + 1} correcta)`; } else if (totalCorrectOptions > 0 && specifiedCorrectWeightSum < 99.9) { stepValue = 1.0 / totalCorrectOptions; stepText = `+${(stepValue * 100).toFixed(1)}% (Opción ${optIndex + 1} correcta - default)`; } else { stepValue = 0; stepText = `+0% (Opción ${optIndex + 1} correcta - peso excedido)`; } } else { if (opt.percentage !== null && opt.percentage < 0) { stepValue = opt.percentage / 100.0; stepText = `${opt.percentage}% (Opción ${optIndex + 1} incorrecta - penalización)`; } else { stepValue = 0; stepText = `0% (Opción ${optIndex + 1} incorrecta - sin penalización)`; } } if(isSelected) { q.calculationSteps.push({ value: stepValue, text: stepText }); intermediateQuestionScore += stepValue; } } }); } q.intermediateScore = Math.round(intermediateQuestionScore * 1000) / 1000; const finalQuestionScore = Math.max(0, intermediateQuestionScore); q.score = Math.round(finalQuestionScore * 1000) / 1000; if (finalQuestionScore >= 0.999) { correctQuestions++; statusSpan.textContent = 'Correcta'; statusSpan.classList.add('status-correct'); questionHeader.classList.add('header-correct'); feedbackDiv.textContent = q.feedback.correct || '¡Correcto!'; feedbackDiv.classList.add('feedback-correct'); } else if (finalQuestionScore > 0) { partiallyCorrectQuestions++; statusSpan.textContent = 'Parcialmente Correcta'; statusSpan.classList.add('status-partially-correct'); questionHeader.classList.add('header-partially-correct'); feedbackDiv.textContent = q.feedback.incorrect || 'Parcialmente correcto.'; feedbackDiv.classList.add('feedback-partially-correct'); } else { incorrectQuestions++; statusSpan.textContent = 'Incorrecta'; statusSpan.classList.add('status-incorrect'); questionHeader.classList.add('header-incorrect'); feedbackDiv.textContent = q.feedback.incorrect || 'Incorrecto.'; feedbackDiv.classList.add('feedback-incorrect'); } feedbackDiv.style.display = 'block'; inputs.forEach((input, optIndex) => { const isSelected = userAnswerIndices.includes(optIndex); const optionData = q.options[optIndex]; const wrapper = input.closest('.option-wrapper'); const label = wrapper.querySelector('label'); const feedbackIcon = document.createElement('i'); feedbackIcon.className = 'feedback-icon fas'; if (optionData.correct) { wrapper.classList.add('correct-answer-mark'); label.title = 'Correcta'; } if (isSelected) { if (optionData.correct) { feedbackIcon.classList.add('fa-check', 'correct'); } else { feedbackIcon.classList.add('fa-times', 'incorrect'); wrapper.classList.add('user-incorrect-selection'); } label.appendChild(feedbackIcon); } if (optionData.feedback) { const specificFeedbackDiv = document.createElement('div'); specificFeedbackDiv.id = `specific-feedback-${q.id}-${optIndex}`; specificFeedbackDiv.className = 'specific-feedback'; specificFeedbackDiv.innerHTML = optionData.feedback; wrapper.parentNode.insertBefore(specificFeedbackDiv, wrapper.nextSibling); } }); } }); finalTotalScore = simParsedQuestions.reduce((sum, q) => sum + q.intermediateScore, 0); finalTotalScore = Math.round(finalTotalScore * 100) / 100; let detailedCalculationString = "Cálculo detallado por pregunta:\n"; simParsedQuestions.forEach((q, index) => { detailedCalculationString += `P${index + 1}: [ `; if (q.calculationSteps && q.calculationSteps.length > 0) { const intermediateSum = q.calculationSteps.reduce((sum, step) => sum + step.value, 0); detailedCalculationString += q.calculationSteps.map(step => { const sign = step.value >= 0 ? '+' : ''; return `${sign}${step.value.toFixed(3)} (${step.text})`; }).join('; '); detailedCalculationString += ` ] = ${intermediateSum.toFixed(3)} -> Score Pregunta (limitado >=0): ${q.score.toFixed(3)}\n`; } else { detailedCalculationString += ` (Error al obtener pasos) ] -> Score Pregunta: ${q.score.toFixed(3)}\n`; } }); let scoreOutOfTen = 0; if (maxScore > 0) { scoreOutOfTen = (finalTotalScore / maxScore) * 10; } const formattedScoreOutOfTen = scoreOutOfTen.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); const percentage = (maxScore > 0) ? ((finalTotalScore / maxScore) * 100) : 0; const percentageFormatted = percentage.toLocaleString('es-ES', { minimumFractionDigits: 1, maximumFractionDigits: 1 }); const now = new Date(); const finishTime = now.toLocaleString('es-ES', { dateStyle: 'long', timeStyle: 'medium' }); const finalTotalScoreFormatted = finalTotalScore.toLocaleString('es-ES', {minimumFractionDigits: 2, maximumFractionDigits: 2}); simScoreSummary.innerHTML = `<p>Intento finalizado el: ${finishTime}</p><p>Calificación final: <strong>${finalTotalScoreFormatted}</strong> sobre ${maxScore.toFixed(1)} (<strong>${percentageFormatted}%</strong>)</p><p class="score-out-of-10">Nota sobre 10: ${formattedScoreOutOfTen}</p><div><span class="score-calc-label">Detalle del Cálculo<button class="btn btn-outline-secondary btn-sm calculation-toggle-button" type="button" data-toggle="collapse" data-target="#collapseCalculation" aria-expanded="false" aria-controls="collapseCalculation" title="Mostrar/Ocultar Cálculo"><i class="fas fa-chevron-down"></i></button></span><div class="collapse" id="collapseCalculation"><pre class="score-calc-display"><code>${detailedCalculationString}</code></pre></div></div><ul class="results-details"><li>Preguntas Totales: ${simParsedQuestions.length}</li><li class="correct-count"><i class="fas fa-check-circle mr-1"></i> Correctas (Score final ≈ 1.0): ${correctQuestions}</li><li class="partial-count"><i class="fas fa-adjust mr-1"></i> Parcialmente Correctas (Score final > 0 y < 1.0): ${partiallyCorrectQuestions}</li><li class="incorrect-count"><i class="fas fa-times-circle mr-1"></i> Incorrectas (Score final = 0): ${incorrectQuestions}</li>${unansweredQuestions > 0 ? `<li><i class="fas fa-question-circle mr-1"></i> Sin responder: ${unansweredQuestions}</li>` : ''}</ul>`;
                if(simResultsArea) simResultsArea.style.display = 'block'; if(simSubmitButton) { simSubmitButton.disabled = true; simSubmitButton.innerHTML = '<i class="fas fa-check-double mr-1"></i> Corregido'; } simSubmissionMade = true; const resultsButtonsContainer = simResultsArea?.querySelector('.results-buttons'); if (resultsButtonsContainer) resultsButtonsContainer.style.display = 'flex'; if(simRetryButton) simRetryButton.style.display = 'inline-block'; if(simResetButton) simResetButton.style.display = 'inline-block'; if(simResultsArea) simResultsArea.scrollIntoView({ behavior: 'smooth' });
             });
                 simResetButton.addEventListener('click', simResetUI); function simResetUI() { /* ... sin cambios ... */ simParsedQuestions = []; simSubmissionMade = false; if(simQuizDisplayArea) { simQuizDisplayArea.style.display = 'none'; simQuizDisplayArea.innerHTML = ''; } if(simSubmitButton) { simSubmitButton.style.display = 'none'; simSubmitButton.disabled = false; simSubmitButton.innerHTML = '<i class="fas fa-check-circle mr-1"></i> Enviar Intento y Corregir'; } if(simResultsArea) simResultsArea.style.display = 'none'; if(simScoreSummary) simScoreSummary.innerHTML = ''; if(simRetryButton) simRetryButton.style.display = 'none'; if(simResetButton) simResetButton.style.display = 'none'; if(simUploadArea) simUploadArea.style.display = 'block'; if(simFileInput) simFileInput.value = ''; simHideParseError(); if(simFileInfo) { simFileInfo.style.display = 'none'; simFileInfo.textContent = ''; } }
                 simRetryButton.addEventListener('click', simHandleRetryQuiz); function simHandleRetryQuiz() { /* ... sin cambios ... */ if (!simParsedQuestions || simParsedQuestions.length === 0) return; simSubmissionMade = false; simParsedQuestions.forEach(q => { const card = document.getElementById(q.id); if (!card) return; const inputs = card.querySelectorAll(`input[name="${q.id}"]`); inputs.forEach(input => { input.checked = false; input.disabled = false; }); const statusSpan = card.querySelector(`#status-${q.id}`); const questionHeader = statusSpan.closest('.question-header'); statusSpan.className = 'question-status status-unanswered'; statusSpan.textContent = 'Sin responder'; questionHeader.className = 'question-header header-unanswered'; const specificFeedbacks = card.querySelectorAll('.specific-feedback'); specificFeedbacks.forEach(fb => fb.remove()); const generalFeedback = card.querySelector(`#feedback-${q.id}`); if(generalFeedback) { generalFeedback.innerHTML = ''; generalFeedback.style.display = 'none'; generalFeedback.className = 'general-feedback'; } const wrappers = card.querySelectorAll('.option-wrapper'); wrappers.forEach(wrapper => { wrapper.classList.remove('correct-answer-mark', 'user-incorrect-selection'); wrapper.style.borderLeftColor = 'transparent'; const label = wrapper.querySelector('label'); if(label) label.title = ''; const icon = wrapper.querySelector('.feedback-icon'); if (icon) icon.remove(); const labelInside = wrapper.querySelector('label'); if (labelInside) labelInside.style.textDecoration = 'none'; }); q.score = 0; q.intermediateScore = 0; q.calculationSteps = []; }); if(simResultsArea) simResultsArea.style.display = 'none'; if(simSubmitButton) { simSubmitButton.disabled = false; simSubmitButton.innerHTML = '<i class="fas fa-check-circle mr-1"></i> Enviar Intento y Corregir'; } if(simQuizDisplayArea) simQuizDisplayArea.scrollIntoView({ behavior: 'smooth' }); }

             // Añadir comprobaciones finales para elementos DOM del simulador
             if (!simUploadArea || !simQuizDisplayArea) {
                 console.error("Error crítico: Faltan los contenedores principales del simulador (#upload-area, #quiz-display-area).");
             }

            }); // Fin DOMContentLoaded Simulador
        })(); // Fin IIFE simulador
    </script>

    <!-- Bootstrap JS Dependencies (al final) -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.3/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>
</html>
